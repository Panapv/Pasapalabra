<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pasapalabra</title>
</head>
<style>
    .currentLetter {
        border: 2px solid lightskyblue;

    }

    .correct {
        background-color: lightgreen;
    }

    .incorrect {
        background-color: red;
    }

    .abecedario {
        background-color: white;
    }
</style>

<body>
    <div>
        <p id="timer"></p>
        <p id="aciertos"></p>
        <p id="fallos"></p>
    </div>
    <form id="form">
        <table>
            <tr id="table">

            </tr>
        </table>
        <input type="text" id="text_box">
        <button type="submit" value="0" id="skip">Pasapalabra</button>
        <button type="submit" value="1" id="next">Contestar</button>
    </form>
</body>
<script src="preguntas.js"></script>
<script>
    if (!sessionStorage.getItem("preguntas")) {
        sessionStorage.setItem("preguntas", JSON.stringify(preguntas));
    }

    if (!sessionStorage.getItem("iteration")) {
        sessionStorage.setItem("iteration", 0);
    }

    if (!sessionStorage.getItem("aciertos")) {
        sessionStorage.setItem("aciertos", 0);
    }

    if (!sessionStorage.getItem("fallos")) {
        sessionStorage.setItem("fallos", 0);
    }

    if (!sessionStorage.getItem("timer")) {
        sessionStorage.setItem("timer", 300);
    }

    function cleanString(str) {
        //primero quitamos los espacios al principio y al final
        str = str.trim();
        //segundo eliminamos acentos y lo convertimos a minusculas
        str = str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        return str;
    }

    function enviarForm(event) {
        //Cargamos las variables de sesion
        let preguntasSS = JSON.parse(sessionStorage.getItem("preguntas"));

        //Primero comprobamos si ha contestado o pasapalabra.
        if (event.submitter.value > 0) {
            //A continuación comprobamos que la respuesta sea correcta.
            let i = sessionStorage.getItem("iteration");
            let elemento = preguntasSS[i];
            let true_response = cleanString(elemento.respuesta);
            let user_response = cleanString(document.getElementById("text_box").value);

            if (true_response == user_response) {
                alert("Has acertado la pregunta");
                preguntasSS[i].estado = 2;
                let value = parseInt(sessionStorage.getItem("aciertos"));
                value++;
                sessionStorage.setItem("aciertos", value);
            } else {
                alert("Has fallado la pregunta");
                preguntasSS[i].estado = 1;
                let value = parseInt(sessionStorage.getItem("fallos"));
                value++;
                sessionStorage.setItem("fallos", value);
            }

            //actualizamos las preguntas en el sessionStorage
            sessionStorage.setItem("preguntas", JSON.stringify(preguntasSS));
        } else {
            //alert("Pasapalabra!");
        }

        //Por último itereamos hasta la próxima pregunta sin contestar.
        do {
            iterarRosco();
        } while (preguntasSS[sessionStorage.getItem("iteration")].estado > 0);
    }

    function iterarRosco() {
        let value = parseInt(sessionStorage.getItem("iteration"));
        value++;
        if (value < 26) {
            sessionStorage.setItem("iteration", value);
        } else {
            sessionStorage.setItem("iteration", 0);
        }
    }

    function printRosco() {
        let i = 0;
        let preguntaSS = JSON.parse(sessionStorage.getItem("preguntas"));
        for (let element of preguntaSS) {
            let row = document.getElementById("table");
            let celda = document.createElement("td");
            celda.innerHTML = element.letra;

            // Indicamos la clase que recibirá el div
            if (element.estado == 1) {
                celda.className = "incorrect"
            } else if (element.estado == 2) {
                celda.className = "correct"
            } else {
                if (sessionStorage.getItem("iteration") == i) {
                    celda.className = "currentLetter";
                } else {
                    celda.className = "abecedario";
                }
            }
            row.appendChild(celda);
            i++;
        }
    }

    function printAciertosFallos() {
        let aciertos = parseInt(sessionStorage.getItem("aciertos"));
        let fallos = parseInt(sessionStorage.getItem("fallos"));

        let tag_aciertos = document.getElementById("aciertos");
        let tag_fallos = document.getElementById("fallos");

        tag_aciertos.innerHTML = "Aciertos: " + aciertos;
        tag_fallos.innerHTML = "Fallos: " + fallos;
    }

    function updateTimer() {
        let tiempoRestante = parseInt(sessionStorage.getItem("timer"));
        const display = document.getElementById("timer");

        display.textContent = tiempoRestante + "s";

        if (tiempoRestante <= 0) {
            clearInterval(intervalo);
            alert("¡Tiempo finalizado!"); // Acción cuando el tiempo termina
            sessionStorage.removeItem("timer");
        } else {
            tiempoRestante--;
            sessionStorage.setItem("timer", tiempoRestante);
        }
    }

    function printWebHTML() {
        printRosco();
        printAciertosFallos();
        let intervalo = setInterval(updateTimer, 1000);
        updateTimer();
    }

    // añadimos el evento submit al formulario
    let form = document.getElementById("form");
    form.addEventListener("submit", enviarForm);

    //Pintamos el contenido de la pagina web
    printWebHTML();
</script>

</html>